<!DOCTYPE html>
<html>
<head>
    <title>Postal Code Map Search</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        #map-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
        }
        #search-container {
            margin-bottom: 15px;
        }
        #postalCodeInput {
            padding: 10px;
            width: 200px;
            margin-right: 10px;
        }
        #searchButton {
            padding: 10px 15px;
            background-color: #4285F4;
            color: white;
            border: none;
            cursor: pointer;
        }
        #searchButton:hover {
            background-color: #3367D6;
        }
        #map {
            height: 80vh;
            width: 100%;
            border: 1px solid #ddd;
            position: relative;
        }
        #locationInfo {
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        .error {
            color: red;
            font-weight: bold;
            padding: 10px;
            background-color: #ffeeee;
            border-radius: 4px;
            margin: 10px 0;
        }
        /* FAB Button Style */
        .fab {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: #4285F4;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1000;
            border: none;
        }
        .fab svg {
            fill: #ffffff;
            width: 24px;
            height: 24px;
        }
        .fab:hover {
            background-color: #3367D6;
        }
        /* Loading indicator */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 0 auto 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Fallback map style */
        .fallback-map {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            background-color: #f5f5f5;
            padding: 20px;
            text-align: center;
        }
        .permission-request {
            background-color: #e8f0fe;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="search-container">
            <input type="text" id="postalCodeInput" placeholder="Enter postal code">
            <button id="searchButton">Search</button>
            <div id="locationInfo"></div>
            <div id="errorMessage" class="error" style="display: none;"></div>
            <div id="permissionRequest" class="permission-request" style="display: none;">
                <p>This app needs location permission to show your position on the map.</p>
                <button id="requestPermissionBtn" style="padding: 8px 15px; background-color: #4285F4; color: white; border: none; border-radius: 4px; cursor: pointer;">Allow Location Access</button>
            </div>
        </div>
        <div id="map">
            <div id="loadingIndicator" class="loading">
                <div class="spinner"></div>
                <p>Loading map...</p>
            </div>
            <div id="fallbackMap" class="fallback-map" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="#ccc">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                </svg>
                <h3>Map could not be loaded</h3>
                <p>Please check your internet connection and try again.</p>
                <button id="retryMapBtn" style="padding: 8px 15px; background-color: #4285F4; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">Retry</button>
            </div>
        </div>
        <!-- FAB Button for Current Location -->
        <button class="fab" id="locationButton">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
            </svg>
        </button>
    </div>

    <!-- JavaScript code -->
    <script>
        // Global variables
        let map;
        let marker;
        let mapInitialized = false;
        let userLocationMarker;
        let geocoder;
        let mapLoadAttempts = 0;
        const MAX_MAP_LOAD_ATTEMPTS = 3;
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Set up event listeners
            document.getElementById("searchButton").addEventListener("click", searchByPostalCode);
            document.getElementById("postalCodeInput").addEventListener("keypress", function(e) {
                if (e.key === "Enter") {
                    searchByPostalCode();
                }
            });
            document.getElementById("locationButton").addEventListener("click", getUserLocation);
            document.getElementById("requestPermissionBtn").addEventListener("click", requestLocationPermission);
            document.getElementById("retryMapBtn").addEventListener("click", loadGoogleMaps);
            
            // Load Google Maps
            loadGoogleMaps();
        });
        
        // Load Google Maps API dynamically
        function loadGoogleMaps() {
            // Hide fallback map if visible
            document.getElementById("fallbackMap").style.display = "none";
            // Show loading indicator
            document.getElementById("loadingIndicator").style.display = "block";
            
            // Check if we've already tried loading the API too many times
            if (mapLoadAttempts >= MAX_MAP_LOAD_ATTEMPTS) {
                showMapLoadError("Failed to load Google Maps after multiple attempts. Please try again later.");
                return;
            }
            
            mapLoadAttempts++;
            
            // Try multiple API keys (you can add your own keys here)
            const apiKeys = [
                "AIzaSyB41DRUbKWJHPxaFjMAwdrzWzbVKartNGg", // Example public key 1
                "AIzaSyC4lxG3s9qKkZWa-XrQmLYgB8vh7j1z3iY", // Example public key 2
                "AIzaSyDSPDpkFznGgzzBSsYvTq_sj0T0QCHRgwM"  // Example public key 3
            ];
            
            // Choose a key based on the current attempt
            const keyIndex = (mapLoadAttempts - 1) % apiKeys.length;
            const apiKey = apiKeys[keyIndex];
            
            // Create script element for Google Maps API
            const script = document.createElement("script");
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initMap`;
            script.async = true;
            script.defer = true;
            
            // Set timeout to check if loading was successful
            const timeoutId = setTimeout(() => {
                if (!mapInitialized) {
                    console.error("Google Maps API load timed out.");
                    script.remove();
                    loadGoogleMaps(); // Try with next key
                }
            }, 5000);
            
            // Handle script load error
            script.onerror = function() {
                clearTimeout(timeoutId);
                console.error("Error loading Google Maps API.");
                script.remove();
                loadGoogleMaps(); // Try with next key
            };
            
            // Add script to document
            document.body.appendChild(script);
            
            // Global callback function for Google Maps API
            window.initMap = function() {
                clearTimeout(timeoutId);
                try {
                    // Default location (center of Thailand)
                    const defaultLocation = { lat: 13.7563, lng: 100.5018 };
                    
                    // Create map
                    map = new google.maps.Map(document.getElementById("map"), {
                        center: defaultLocation,
                        zoom: 6,
                        mapTypeControl: false,
                        fullscreenControl: false,
                        streetViewControl: false
                    });
                    
                    // Create geocoder
                    geocoder = new google.maps.Geocoder();
                    
                    // Mark initialization as successful
                    mapInitialized = true;
                    
                    // Hide loading indicator
                    document.getElementById("loadingIndicator").style.display = "none";
                    
                    // Check if postal code is already entered
                    const postalCode = document.getElementById("postalCodeInput").value.trim();
                    if (postalCode) {
                        searchByPostalCode();
                    }
                    
                    console.log("Google Maps initialized successfully!");
                } catch (error) {
                    console.error("Error initializing Google Maps:", error);
                    showMapLoadError("Error initializing Google Maps: " + error.message);
                }
            };
        }
        
        // Show map loading error
        function showMapLoadError(message) {
            document.getElementById("loadingIndicator").style.display = "none";
            document.getElementById("fallbackMap").style.display = "flex";
            document.getElementById("errorMessage").textContent = message;
            document.getElementById("errorMessage").style.display = "block";
            console.error(message);
        }
        
        // Search by postal code
        function searchByPostalCode() {
            if (!mapInitialized) {
                document.getElementById("locationInfo").innerHTML = 
                    "Google Maps is not loaded yet. Please wait or try refreshing the page.";
                return;
            }
            
            const postalCode = document.getElementById("postalCodeInput").value.trim();
            const locationInfo = document.getElementById("locationInfo");
            
            if (!postalCode) {
                locationInfo.innerHTML = "Please enter a postal code";
                return;
            }
            
            locationInfo.innerHTML = "Searching...";
            
            geocoder.geocode({ 'address': postalCode }, function(results, status) {
                if (status === "OK") {
                    // Clear previous marker if exists
                    if (marker) {
                        marker.setMap(null);
                    }
                    
                    // Get the first result
                    const location = results[0].geometry.location;
                    const address = results[0].formatted_address;
                    
                    // Create new marker
                    marker = new google.maps.Marker({
                        map: map,
                        position: location,
                        title: address,
                        animation: google.maps.Animation.DROP
                    });
                    
                    // Center map on the location
                    map.setCenter(location);
                    map.setZoom(15);
                    
                    // Display location information
                    locationInfo.innerHTML = `
                        <strong>Found location:</strong> ${address}<br>
                        <strong>Coordinates:</strong> ${location.lat().toFixed(6)}, ${location.lng().toFixed(6)}
                    `;
                } else {
                    locationInfo.innerHTML = "Location not found for postal code: " + postalCode;
                    console.error("Geocoder failed: " + status);
                }
            });
        }
        
        // Request location permission
        function requestLocationPermission() {
            document.getElementById("permissionRequest").style.display = "none";
            getUserLocation();
        }
        
        // Get user's current location
        function getUserLocation() {
            if (!mapInitialized) {
                document.getElementById("locationInfo").innerHTML = 
                    "Google Maps is not loaded yet. Please wait or try refreshing the page.";
                return;
            }
            
            if (navigator.geolocation) {
                document.getElementById("locationInfo").innerHTML = "Getting your location...";
                
                navigator.geolocation.getCurrentPosition(
                    // Success callback
                    function(position) {
                        const userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Clear previous user location marker
                        if (userLocationMarker) {
                            userLocationMarker.setMap(null);
                        }
                        
                        // Create marker for user's location
                        userLocationMarker = new google.maps.Marker({
                            map: map,
                            position: userLocation,
                            title: "Your Location",
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 10,
                                fillColor: "#4285F4",
                                fillOpacity: 1,
                                strokeColor: "white",
                                strokeWeight: 2
                            },
                            zIndex: 1000
                        });
                        
                        // Add accuracy circle
                        const accuracyCircle = new google.maps.Circle({
                            map: map,
                            center: userLocation,
                            radius: position.coords.accuracy,
                            strokeColor: "#4285F4",
                            strokeOpacity: 0.2,
                            strokeWeight: 1,
                            fillColor: "#4285F4",
                            fillOpacity: 0.1,
                            zIndex: 999
                        });
                        
                        // Center map on user location
                        map.setCenter(userLocation);
                        map.setZoom(16);
                        
                        // Display user location information
                        document.getElementById("locationInfo").innerHTML = `
                            <strong>Your location:</strong><br>
                            <strong>Coordinates:</strong> ${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}<br>
                            <strong>Accuracy:</strong> ${Math.round(position.coords.accuracy)} meters
                        `;
                        
                        // Try to get address from coordinates
                        geocoder.geocode({ 'location': userLocation }, function(results, status) {
                            if (status === "OK" && results[0]) {
                                document.getElementById("locationInfo").innerHTML += `
                                    <br><strong>Address:</strong> ${results[0].formatted_address}
                                `;
                            }
                        });
                    },
                    // Error callback
                    function(error) {
                        let errorMessage = "Unable to retrieve your location: ";
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += "User denied the request for Geolocation.";
                                // Show permission request UI
                                document.getElementById("permissionRequest").style.display = "block";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += "Location information is unavailable.";
                                break;
                            case error.TIMEOUT:
                                errorMessage += "The request to get user location timed out.";
                                break;
                            case error.UNKNOWN_ERROR:
                                errorMessage += "An unknown error occurred.";
                                break;
                        }
                        
                        document.getElementById("locationInfo").innerHTML = errorMessage;
                        console.error("Geolocation Error:", error);
                    },
                    // Options
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                document.getElementById("locationInfo").innerHTML = 
                    "Geolocation is not supported by this browser.";
            }
        }
    </script>
</body>
</html>
